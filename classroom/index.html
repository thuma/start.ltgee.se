<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="lz-string.js"></script>
    <style>
     .whitep {
       color: white;
     }
     .nolnb {
       white-space: nowrap;
     }
    </style>
    <title>Classroom FGUI</title>
  </head>
  <body>
    <div class="container-fluid">
      <script>
        var GoogleAuth;
        var Scopes = [
          "https://www.googleapis.com/auth/classroom.rosters",
          "https://www.googleapis.com/auth/classroom.rosters.readonly",
          "https://www.googleapis.com/auth/classroom.profile.emails",
          "https://www.googleapis.com/auth/classroom.profile.photos",
          "https://www.googleapis.com/auth/classroom.courses.readonly",
          "https://www.googleapis.com/auth/classroom.coursework.students.readonly",
          "https://www.googleapis.com/auth/classroom.student-submissions.students.readonly"
        ]

        var SCOPE = Scopes.join(" ");
        function handleClientLoad() {
          // Load the API's client and auth2 modules.
          // Call the initClient function after the modules load.
          gapi.load('client:auth2', initClient);
        }
      
        function initClient() {
          // In practice, your app can retrieve one or more discovery documents.
          var discoveryUrl = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      
          // Initialize the gapi.client object, which app uses to make API requests.
          // Get API key and client ID from API Console.
          // 'scope' field specifies space-delimited list of access scopes.
          gapi.client.init({
              'apiKey': 'AIzaSyBJbdSNcDcq_C86__XSvsRHaF0GgLdRIDA',
              'clientId': '895135418381-m1fmm24b5h76upit18r43f8su4pptld9.apps.googleusercontent.com',
              'discoveryDocs': [discoveryUrl],
              'scope': SCOPE
          }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
      
            // Listen for sign-in state changes.
            GoogleAuth.isSignedIn.listen(updateSigninStatus);
      
            // Handle initial sign-in state. (Determine if user is already signed in.)
            var user = GoogleAuth.currentUser.get();
            setSigninStatus();
      
            // Call handleAuthClick function when user clicks on
            //      "Sign In/Authorize" button.
            $('#sign-in-or-out-button').click(function() {
              handleAuthClick();
            });
            $('#revoke-access-button').click(function() {
              revokeAccess();
            });
          });
        }
      
        function handleAuthClick() {
          if (GoogleAuth.isSignedIn.get()) {
            // User is authorized and has clicked "Sign out" button.
            GoogleAuth.signOut();
          } else {
            // User is not signed in. Start Google auth flow.
            GoogleAuth.signIn();
          }
        }
      
        function revokeAccess() {
          GoogleAuth.disconnect();
        }
      
        function setSigninStatus() {
          var user = GoogleAuth.currentUser.get();
          var isAuthorized = user.hasGrantedScopes('https://www.googleapis.com/auth/classroom.courses.readonly');
          if (isAuthorized) {
            $('#sign-in-or-out-button').html('Logga ut');
            $('#revoke-access-button').css('display', 'inline-block');
            $('#auth-status').html('Du √§r inloggad');
          } else {
            $('#sign-in-or-out-button').html('Logga in');
            $('#revoke-access-button').css('display', 'none');
            $('#auth-status').html('Du √§r inte inloggad');
          }
        }
      
        function updateSigninStatus() {
          setSigninStatus();
        }
      </script>
    
      <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
      
      <div id="classroom">
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title">Kurser</h5>
                <p class="card-text">Aktiva kurser</p>
                <table class="card-body table table-sm">
                  <tbody>
                    <tr v-for="klass in courses">
                      <td>{{ klass.name }}</td>
                      <td><a href="#" v-on:click="show=klass.id">√ñversikt</a></td>
                      <td><a v-bind:href="klass.alternateLink" target="_blank">Classroom</a></td>
                      <td><a v-bind:href="'https://script.google.com/macros/s/AKfycbzDuxI8tB2RExex7w6AdAq-pQjZfqgY5YRqEfX5xTK4bZyLqxU/exec?course='+klass.id" target="_blank">Elevl√§nk</a></td>
                      <td><a v-bind:href="'mailto:'+klass.courseGroupEmail" target="_blank">Gruppmail</a></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
                <table class="table table-sm" v-if="show">
                  <thead class="thead-light">
                    <tr>
                      <th>Namn</th>
                      <th>Klass <button class="btn btn-info btn-sm">alla</button></th>
                      <th v-bind:title="work.title" v-for="work in courceData.courseWork">
                        <a v-bind:href="work.alternateLink" target="_blank">{{ work.title.split(" ")[0] }}</a>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="student in courceData.students">
                      <td class="bg-light nolnb">
                        <input type="checkbox" name="students" />
                        <a v-bind:href="'mailto:'+student.emailAddress">{{ student.name.fullName }}</a>
                      </td>
                      <td></td>
                      <template v-for="work in getSubmissions(student.id)">
                      <td v-if="['NEW','CREATED','RECLAIMED_BY_STUDENT'].indexOf(work.state) > -1 " class="bg-light">
                        <a target="_blank" v-bind:href="work.alternateLink">‚òê</a>
                      </td>
                      <td v-else-if="work.state == 'TURNED_IN'" class="bg-info">
                        <a target="_blank" v-bind:href="work.alternateLink">üÜï</a>
                      </td>
                      <td v-else-if="work.provResultat > 1" v-bind:class="work.provNiva">
                        <a target="_blank" style="color:black;" v-bind:href="work.alternateLink">
                          {{ work.provResultat }}%
                        </a>
                      </td>
                      <td v-else-if="work.state == 'RETURNED' && work.assignedGrade > 0 " class="bg-success">
                        <a target="_blank" v-bind:href="work.alternateLink">‚òë</a></td>
                      <td v-else-if="work.state == 'RETURNED'" class="bg-warning">
                        <a target="_blank" v-bind:href="work.alternateLink">‚Ü©</a></td>
                      </td>
                      <td v-else="">{{work.state}}</td>
                      </template>
                    </tr>
                  </tbody>
                </table>
      </div>
      
      <script>
      var courses_data = localStorage.getItem("courses");
      if(courses_data){
        courses_data = JSON.parse(LZString.decompress(courses_data));
      } else {
        courses_data = [];
      }
      var app = new Vue({
        el: '#classroom',
        data: {
          courses: window.courses_data,
          show: ""
        },
        computed: {
          courceData: function(){
            if (this.show) {
              function byTaskName( a, b ) {
  		if ( a.title < b.title ){
    		  return -1;
  		}
                if ( a.title > b.title ){
                  return 1;
                }
                return 0;
              }
              var final = this.courses.find(element => element.id == this.show);
              final.courseWork = final.courseWork.sort(byTaskName)
              return final;
            }
            else {
              return {};
            }
          }
        },
        methods: {
          update: function(){
            var app = this;
            function indata(data){
              app.courses = data.result.courses;
              app.getCourseWork();
              app.getStudents();
              app.getStudentSubmissions();
              app.save();
            }
            gapi.client.request({"path":"https://classroom.googleapis.com/v1/courses","params":{"courseStates":"ACTIVE"}}).then(indata)
          },
          save: function(){
            localStorage.setItem("courses", LZString.compress(JSON.stringify(this.courses)));
          },
          getSubmissions: function (elevid){
              var alla = [];
              for(var i = 0; i < this.courceData.courseWork.length; i++){
                alla.push(this.getSubmission(elevid, this.courceData.courseWork[i]));
              }
              return alla;
          },
          getSubmission: function (elevid, uppgift){
             var hittad = this.courceData.submissions.find(
		task => task.courseWorkId == uppgift.id && task.userId == elevid)
             if (hittad) {
               hittad["courseWork"] = uppgift;
               if (hittad.courseWork.maxPoints > 1  && hittad.assignedGrade > 0){
                 hittad["provResultat"] = Math.round(hittad.assignedGrade / hittad.courseWork.maxPoints * 100);
                 if(hittad["provResultat"] < 50){
                   hittad["provNiva"] = "bg-danger";
                 } else if (hittad["provResultat"] < 55) {
                   hittad["provNiva"] = "bg-warning";
                 } else { 
                   hittad["provNiva"] = "bg-success";
                 }
               }
               return hittad;
             }
             return {"state":""};
          },
          getStudents: function (){
            var app = this;
            this.courses.forEach(function(kurs){
              var kurser = kurs
              function students(data){
                function studentUpdate(student){
                  if(kurser.students){} else {
                    kurser.students = []
                  }
                  kurser.students.push(student.profile);
                }
                data.result.students.forEach(studentUpdate);
              }                
              gapi.client.request({"path":"https://classroom.googleapis.com/v1/courses/"+kurs.id+"/students","params":{}}).then(students)
            })
          },
          getCourseWork: function (){
            var app = this;
            this.courses.forEach(function(kurs){
              var kurser = kurs
              function courseWork(data){
                function courseWorkUpdate(onecourseWork){
                  if(kurser.courseWork){} else {
                    kurser.courseWork = []
                  }
                  kurser.courseWork.push(onecourseWork);
                }
                if(data.result.courseWork){
                  data.result.courseWork.forEach(courseWorkUpdate);
                }
              }                
              gapi.client.request({"path":"https://classroom.googleapis.com/v1/courses/"+kurs.id+"/courseWork","params":{}}).then(courseWork)
            })
          },
          getStudentSubmissions: function (){
            var app = this;
            this.courses.forEach(function(kurs){
              var kurser = kurs
              function courseWorkSubmission(data){
                function courseWorkSubmissionUpdate(onecourseWorkSubmission){
                  if("submissions" in kurser){} else {
                    kurser.submissions = []
                  }
                  kurser.submissions.push(onecourseWorkSubmission);
                }
                if(data.result.studentSubmissions){
                  data.result.studentSubmissions.forEach(courseWorkSubmissionUpdate);
                }
                if(data.result.nextPageToken){
                  gapi.client.request(
                      {"path":"https://classroom.googleapis.com/v1/courses/"+kurser.id+"/courseWork/-/studentSubmissions",
                      "params":{"pageToken":data.result.nextPageToken}}
                      ).then(courseWorkSubmission);
                }
              }
              gapi.client.request({"path":"https://classroom.googleapis.com/v1/courses/"+kurs.id+"/courseWork/-/studentSubmissions","params":{}}).then(courseWorkSubmission)
            })
          }
        }
      })
      </script>
      <button id="sign-in-or-out-button" class="btn btn-secondary">Logga in</button>
      <button id="revoke-access-button" class="btn btn-secondary">St√§ng av</button>
      <div id="auth-status" style="display: inline; padding-left: 25px"></div>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
    </div>
  </body>
</html>
